<!DOCTYPE html>
<html lang="en">
<head>
    <title>Edit Note</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/note.css') }}">
    <style>
        /* Additional styles specific to this page */
        body {
            font-family: 'Times New Roman', serif;
        }

        .content {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            margin-top: 20px;
        }

        .main {
            margin-right: 20px;
        }

        .sidebar {
            border-left: 1px solid #ccc;
            padding-left: 20px;
        }
    </style>
    <script>
/*
        function captureHighlight() {
            const selection = window.getSelection();
            if (!selection.toString()) {
                alert('Please select text to highlight.');
                return;
            }
            const range = selection.getRangeAt(0);
            const mark = document.createElement('mark');
            range.surroundContents(mark);
        }
*/
        function captureHighlight() {
            const selection = window.getSelection();
            if (!selection.toString()) {
                alert('Please select text to highlight.');
                return;
            }

            const range = selection.getRangeAt(0);
            const container = range.commonAncestorContainer;

            // Remove all existing marks within the selection
            removeMarksInRange(range);

            const mark = document.createElement('mark');
            range.surroundContents(mark);
        }

        function removeMarksInRange(range) {
            let container = range.commonAncestorContainer;
            while (container && container.nodeType !== Node.ELEMENT_NODE) {
                container = container.parentNode;
            }
        
            if (!container) {
                console.error('No valid container found for querySelectorAll.');
                return;
            }
        
            const marks = container.querySelectorAll('mark');
            marks.forEach(mark => {
                if (range.intersectsNode(mark)) {
                    // Extract text content from the mark
                    const textContent = mark.textContent;
                    
                    // Replace mark with its text content
                    const textNode = document.createTextNode(textContent);
                    mark.parentNode.replaceChild(textNode, mark);
                }
            });
        }
        
        

        
        function unhighlightSelection() {
            const selection = window.getSelection();
            if (!selection.toString()) {
                alert('Please select highlighted text to unhighlight.');
                return;
            }
            const range = selection.getRangeAt(0);
            const markNode = range.commonAncestorContainer.parentElement;
            if (markNode.tagName.toLowerCase() === 'mark') {
                const parent = markNode.parentNode;
                while (markNode.firstChild) {
                    parent.insertBefore(markNode.firstChild, markNode);
                }
                parent.removeChild(markNode);
            } else {
                alert('Selected text is not highlighted.');
            }
        }

        function summarizeHighlight() {
            const selection = window.getSelection();
            const highlightedText = selection.toString().trim();
            if (!highlightedText) {
                alert('No highlighted text found. Please highlight text first.');
                return;
            }
            fetch("/summarize_selected", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    'text': highlightedText
                })
            })
            .then(response => response.json())
            .then(data => {
                const sidebar = document.getElementById('sidebar');
                const summaryDiv = document.createElement('div');
                summaryDiv.textContent = data.summary;
                sidebar.appendChild(summaryDiv);
            });
        }

        function prepareForm() {
            const contentEditableDiv = document.getElementById('content');
            const hiddenInput = document.getElementById('contentInput');
            hiddenInput.value = contentEditableDiv.innerHTML;
        }

        function autoSaveNote() {
            const contentEditableDiv = document.getElementById('content');
            const noteContent = contentEditableDiv.innerHTML;
            fetch("/edit_note/{{ note['_id'] }}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({
                    'content': noteContent
                })
            })
            .then(response => {
                if (response.ok) {
                    console.log('Note saved successfully.');
                } else {
                    console.error('Failed to save note.');
                }
            });
        }
        setInterval(autoSaveNote, 60000);
    </script>
</head>
<body>
    <h1>Edit Note</h1>
    <div class="content">
        <div class="main">
            <form action="/edit_note/{{ note['_id'] }}" method="POST" onsubmit="prepareForm()">
                <label for="content">Note:</label>
                <div id="content" contenteditable="true">{{ note['content'] | safe }}</div>
                <input type="hidden" id="contentInput" name="content">
                <button type="submit">Save Changes</button>
            </form>
            <button type="button" onclick="captureHighlight()">Capture and Highlight Text</button>
            <button type="button" onclick="unhighlightSelection()">Unhighlight Selected Text</button>
            <button type="button" onclick="summarizeHighlight()">Summarize Highlighted Text</button>
        </div>
        <div class="sidebar" id="sidebar">
            <h2>Summaries</h2>
        </div>
    </div>
    <a href="/createnote">Back to Notes</a>
</body>
</html>
